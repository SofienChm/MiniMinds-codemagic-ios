<div class="ai-assistant-container">
  <!-- EU AI Act Compliance: Disclosure Banner -->
  <div class="ai-disclosure-banner">
    <div class="disclosure-icon">
      <i class="bi bi-robot"></i>
    </div>
    <div class="disclosure-content">
      <span class="disclosure-label">Assistente AI</span>
      <span class="disclosure-text">Stai interagendo con un'intelligenza artificiale</span>
    </div>
    <button class="btn btn-sm btn-outline-light" (click)="requestHumanHelp()" title="Parla con un operatore">
      <i class="bi bi-person-fill"></i>
      <span class="d-none d-md-inline">Assistenza Umana</span>
    </button>
  </div>

  <div class="chat-header">
    <div class="header-content">
      <i class="bi bi-chat-dots"></i>
      <h3>MiniMinds Assistant</h3>
      <span class="privacy-badge" title="I dati dei bambini sono protetti">
        <i class="bi bi-shield-check"></i>
        GDPR
      </span>
    </div>
    <button class="btn btn-sm btn-outline-secondary" (click)="clearChat()">
      <i class="bi bi-trash3"></i> Cancella
    </button>
  </div>

  <div class="messages-container" #messagesContainer>
    <!-- Messages -->
    <div *ngFor="let message of messages"
         class="message"
         [ngClass]="{
           'user-message': message.isUser,
           'ai-message': !message.isUser,
           'blocked-message': message.compliance?.wasBlocked,
           'disclosure-message': message.isDisclosure,
           'escalation-message': message.isEscalation
         }">
      <div class="message-content">
        <!-- Blocked indicator -->
        <div *ngIf="message.compliance?.wasBlocked" class="blocked-indicator">
          <i class="bi bi-shield-lock"></i>
          <span>Richiesta bloccata per privacy</span>
        </div>

        <!-- Message text with preserved line breaks -->
        <div class="message-text" [innerHTML]="formatMessageText(message.content)"></div>

        <!-- Data results -->
        <div *ngIf="hasData(message)" class="message-data">
          <div class="data-header">
            <i class="bi bi-table"></i> Risultati:
          </div>
          <pre class="data-content">{{ formatData(message.data) }}</pre>
        </div>

        <!-- Message metadata -->
        <div class="message-footer">
          <span class="message-time">{{ message.timestamp | date:'short' }}</span>
          <span *ngIf="message.compliance && !message.isUser" class="compliance-badge">
            <i class="bi bi-check-circle"></i>
          </span>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="message ai-message">
      <div class="message-content">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Suggestions (GDPR-safe queries only) -->
  <div *ngIf="showSuggestions" class="suggestions-container">
    <div class="suggestions-header">
      <i class="bi bi-lightbulb"></i>
      Prova a chiedere:
    </div>
    <div class="suggestions-grid">
      <button
        *ngFor="let suggestion of suggestedQueries"
        class="suggestion-btn"
        (click)="useSuggestedQuery(suggestion)">
        {{ suggestion }}
      </button>
    </div>
  </div>

  <!-- Query pre-check warning -->
  <div *ngIf="queryWarning" class="query-warning">
    <i class="bi bi-exclamation-triangle"></i>
    <span>{{ queryWarning }}</span>
  </div>

  <!-- Input area -->
  <div class="input-container">
    <div class="input-group">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="currentQuery"
        (keypress)="onKeyPress($event)"
        (input)="onQueryChange()"
        placeholder="Chiedi informazioni generali sull'asilo..."
        [disabled]="isLoading">
      <button
        class="btn btn-primary"
        (click)="sendMessage()"
        [disabled]="!currentQuery.trim() || isLoading">
        <i class="bi bi-send-fill"></i>
      </button>
    </div>
    <div class="input-hint">
      <i class="bi bi-info-circle"></i>
      Per privacy, non posso accedere a dati individuali dei bambini
    </div>
  </div>

  <!-- Human contact footer -->
  <div class="human-contact-footer">
    <span>Hai bisogno di assistenza personale?</span>
    <a href="mailto:{{ humanContact.email }}">
      <i class="bi bi-envelope"></i> {{ humanContact.email }}
    </a>
    <span *ngIf="humanContact.phone">|</span>
    <a *ngIf="humanContact.phone" href="tel:{{ humanContact.phone }}">
      <i class="bi bi-telephone"></i> {{ humanContact.phone }}
    </a>
  </div>
</div>
